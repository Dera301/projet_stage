"use strict";(self.webpackChunkcolocation_antananarivo=self.webpackChunkcolocation_antananarivo||[]).push([[411],{1792:(e,t,s)=>{s.r(t),s.d(t,{default:()=>N});var r=s(5043),a=s(3216),n=s(8927),i=s(9741),l=s(3063),c=s(3986);const d=["title","titleId"];function o(e,t){let{title:s,titleId:a}=e,n=(0,c.A)(e,d);return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":a},n),s?r.createElement("title",{id:a},s):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"}))}const m=r.forwardRef(o);var u=s(7591),x=s(4538),f=s(9422),h=s(2811);const p=["title","titleId"];function v(e,t){let{title:s,titleId:a}=e,n=(0,c.A)(e,p);return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":a},n),s?r.createElement("title",{id:a},s):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"}))}const g=r.forwardRef(v);var j=s(7438),b=s(8378),w=s(2227),y=s(579);const N=()=>{var e,t,s,c,d;const{conversations:o,sendMessage:p,markAsRead:v,getConversationMessages:N,loading:k,editMessage:E,deleteMessage:S,deleteConversation:A}=(0,n.J)(),{user:C}=(0,i.A)(),L=(0,a.zy)(),[I,M]=(0,r.useState)(null),[R,z]=(0,r.useState)(""),[O,B]=(0,r.useState)([]),[W,Z]=(0,r.useState)(!1),[_,P]=(0,r.useState)(new Set),[D,F]=(0,r.useState)(!1),J=(0,r.useRef)(null),[q,K]=(0,r.useState)(null),[T,H]=(0,r.useState)(new Set),U=o.find(e=>e.id===I),V=(0,r.useCallback)(async e=>{if(!N)return;const t=await N(e);B(t)},[N]);(0,r.useEffect)(()=>{I&&V(I)},[I,V]),(0,r.useEffect)(()=>{var e;null===(e=J.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[O]),(0,r.useEffect)(()=>{if(I&&C&&v){const e=O.filter(e=>e.receiverId===C.id&&!e.isRead);e.length>0&&P(e=>new Set([...e,I])),e.forEach(async e=>{try{await v(e.id)}catch(t){console.error("Erreur marquage comme lu:",t)}})}},[I,O,C,v]);const G=async()=>{if(!R.trim()||!U||!C||W)return;const e=U.participants.find(e=>e.id!==C.id);if(e){Z(!0);try{await p(e.id,R),z(""),I&&await V(I)}catch(t){console.error("Erreur lors de l'envoi du message:",t)}finally{Z(!1)}}};(0,r.useEffect)(()=>{o.length>0&&!I&&!k&&!D&&M(o[0].id)},[o,I,k,D]),(0,r.useEffect)(()=>{const e=new URLSearchParams(L.search),t=e.get("to"),s=e.get("prefill");if(!t||0===o.length)return;const r=o.find(e=>e.participants.some(e=>String(e.id)===String(t)));r&&(M(r.id),s&&z(s))},[L.search,o]),(0,r.useEffect)(()=>{I&&F(!1)},[I]),(0,r.useEffect)(()=>{if(!C)return;const e="hidden_conversations_".concat(C.id);try{const t=localStorage.getItem(e);t&&H(new Set(JSON.parse(t)))}catch(t){}},[C]);const Q=e=>{H(t=>{const s=new Set(t);return s.add(e),(e=>{if(!C)return;const t="hidden_conversations_".concat(C.id);try{localStorage.setItem(t,JSON.stringify(Array.from(e)))}catch(s){}})(s),s}),I===e&&M(null),K(null)};(0,r.useEffect)(()=>{const e=()=>K(null);return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[]);return C?(0,y.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,y.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[(0,y.jsxs)("div",{className:"mb-8",children:[(0,y.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"Messages"}),(0,y.jsx)("p",{className:"text-gray-600",children:"Communiquez avec les propri\xe9taires et les \xe9tudiants"})]}),(0,y.jsx)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:(0,y.jsxs)("div",{className:"flex h-[600px]",children:[(0,y.jsxs)("div",{className:"w-1/3 border-r border-gray-200 flex flex-col",children:[(0,y.jsx)("div",{className:"p-4 border-b border-gray-200",children:(0,y.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"Conversations"})}),(0,y.jsx)("div",{className:"flex-1 overflow-y-auto",children:k?(0,y.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,y.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"})}):0===o.filter(e=>!T.has(e.id)).length?(0,y.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[(0,y.jsx)(l.A,{className:"w-12 h-12 mb-4"}),(0,y.jsx)("p",{className:"text-center",children:"Aucune conversation"}),(0,y.jsx)("p",{className:"text-sm text-center mt-2",children:"Commencez une nouvelle conversation depuis une annonce"})]}):(0,y.jsx)("div",{className:"space-y-1",children:o.filter(e=>!T.has(e.id)).map(e=>{const t=e.participants.find(e=>e.id!==C.id);if(!t)return null;const s=(e=>{if(I===e.id)return 0;if(_.has(e.id))return 0;const t=e.lastMessage;if(!t)return 0;const s=String(t.senderId)!==String(null===C||void 0===C?void 0:C.id),r=!t.isRead;return s&&r?1:0})(e);return(0,y.jsx)("button",{onClick:()=>{M(e.id),K(null)},className:"w-full p-4 text-left hover:bg-gray-50 transition-colors ".concat(I===e.id?"bg-primary-50 border-r-2 border-primary-500":""),children:(0,y.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,y.jsx)("div",{className:"w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center",children:(0,y.jsxs)("span",{className:"text-primary-600 font-medium text-sm",children:[t.firstName[0],t.lastName[0]]})}),(0,y.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,y.jsxs)("div",{className:"flex items-center justify-between",children:[(0,y.jsxs)("h3",{className:"text-sm font-medium text-gray-900 truncate",children:[t.firstName," ",t.lastName]}),(0,y.jsxs)("div",{className:"flex items-center space-x-2",onClick:e=>e.stopPropagation(),children:[s>0&&(0,y.jsx)("span",{className:"bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:s}),(0,y.jsxs)("div",{className:"relative",children:[(0,y.jsx)("button",{className:"p-1 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-100",title:"Options",onClick:t=>{t.stopPropagation(),K(t=>t===e.id?null:e.id)},children:(0,y.jsx)(m,{className:"w-5 h-5"})}),q===e.id&&(0,y.jsx)("div",{className:"absolute right-0 mt-1 bg-white border border-gray-200 rounded shadow z-10",children:(0,y.jsx)("button",{className:"block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100",onClick:()=>Q(e.id),children:"Supprimer pour moi"})})]})]})]}),e.lastMessage&&(0,y.jsx)("p",{className:"text-sm truncate ".concat(s>0?"text-gray-900 font-medium":"text-gray-500"),children:e.lastMessage.content}),(0,y.jsx)("p",{className:"text-xs text-gray-400",children:e.lastMessage&&(0,b.m)(new Date(e.lastMessage.createdAt),{addSuffix:!0,locale:w.fr})})]})]})},e.id)})})})]}),(0,y.jsx)("div",{className:"flex-1 flex flex-col",children:U?(0,y.jsxs)(y.Fragment,{children:[(0,y.jsxs)("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[(0,y.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,y.jsx)("div",{className:"w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center",children:(0,y.jsxs)("span",{className:"text-primary-600 font-medium text-sm",children:[null===(e=U.participants.find(e=>e.id!==C.id))||void 0===e?void 0:e.firstName[0],null===(t=U.participants.find(e=>e.id!==C.id))||void 0===t?void 0:t.lastName[0]]})}),(0,y.jsxs)("div",{children:[(0,y.jsxs)("h3",{className:"text-lg font-semibold text-gray-900",children:[null===(s=U.participants.find(e=>e.id!==C.id))||void 0===s?void 0:s.firstName," ",null===(c=U.participants.find(e=>e.id!==C.id))||void 0===c?void 0:c.lastName]}),(0,y.jsx)("p",{className:"text-sm text-gray-500",children:"student"===(null===(d=U.participants.find(e=>e.id!==C.id))||void 0===d?void 0:d.userType)?"\xc9tudiant":"Propri\xe9taire"})]})]}),(0,y.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,y.jsx)("button",{onClick:()=>{M(null),z(""),F(!0)},className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors",title:"Fermer la conversation",children:(0,y.jsx)(u.A,{className:"w-5 h-5"})}),(0,y.jsx)("button",{onClick:async()=>{if(I&&window.confirm("Supprimer cette conversation ? Cette action est irr\xe9versible."))try{await A(I),M(null)}catch(e){}},className:"text-sm text-red-600 hover:text-red-700",title:"Supprimer la conversation",children:"Supprimer"})]})]}),(0,y.jsx)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:0===O.length?(0,y.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[(0,y.jsx)(l.A,{className:"w-12 h-12 mb-4"}),(0,y.jsx)("p",{children:"Aucun message dans cette conversation"}),(0,y.jsx)("p",{className:"text-sm",children:"Envoyez le premier message !"})]}):(0,y.jsx)(y.Fragment,{children:O.map(e=>{const t=String(e.senderId)===String(C.id);return(0,y.jsx)("div",{className:"flex ".concat(t?"justify-end":"justify-start"," mb-2"),children:(0,y.jsxs)("div",{className:"max-w-[75%] px-4 py-2 rounded-2xl shadow-sm ".concat(t?"bg-primary-600 text-white rounded-br-none":"bg-gray-100 text-gray-900 rounded-bl-none border border-gray-200"),children:[(0,y.jsx)("p",{className:"text-sm break-words",children:e.content}),(0,y.jsxs)("div",{className:"flex items-center justify-end mt-1 space-x-1 text-xs ".concat(t?"text-primary-100":"text-gray-500"),children:[(0,y.jsx)("span",{children:(0,b.m)(new Date(e.createdAt),{addSuffix:!0,locale:w.fr})}),t&&(0,y.jsx)("div",{className:"flex items-center",children:e.isRead?(0,y.jsx)(x.A,{className:"w-3 h-3"}):(0,y.jsx)(f.A,{className:"w-3 h-3"})})]}),t&&(0,y.jsxs)("div",{className:"mt-1 flex justify-end space-x-1 text-xs",children:[(0,y.jsx)("button",{className:"p-1 rounded-full text-blue-600 hover:text-blue-700 hover:bg-blue-50",title:"Modifier le message",onClick:async()=>{const t=prompt("Modifier le message:",e.content);if(null!==t&&t.trim()&&t!==e.content)try{await E(e.id,t)}catch(s){}},children:(0,y.jsx)(h.A,{className:"w-4 h-4"})}),(0,y.jsx)("button",{className:"p-1 rounded-full text-red-600 hover:text-red-700 hover:bg-red-50",title:"Supprimer le message",onClick:async()=>{if(window.confirm("Supprimer ce message ?"))try{await S(e.id)}catch(t){}},children:(0,y.jsx)(g,{className:"w-4 h-4"})})]})]})},e.id)})})}),(0,y.jsx)("div",{className:"p-4 border-t border-gray-200",children:(0,y.jsxs)("div",{className:"flex space-x-2",children:[(0,y.jsx)("textarea",{value:R,onChange:e=>z(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),G())},placeholder:"Tapez votre message...",rows:2,className:"flex-1 input-field resize-none",disabled:W}),(0,y.jsx)("button",{onClick:G,disabled:!R.trim()||W,className:"btn-primary flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed",children:W?(0,y.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):(0,y.jsx)(j.A,{className:"w-4 h-4"})})]})})]}):(0,y.jsx)("div",{className:"flex-1 flex items-center justify-center text-gray-500",children:(0,y.jsxs)("div",{className:"text-center",children:[(0,y.jsx)(l.A,{className:"w-16 h-16 mx-auto mb-4"}),(0,y.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:0===o.length?"Aucune conversation":"S\xe9lectionnez une conversation"}),(0,y.jsx)("p",{children:0===o.length?"Commencez une nouvelle conversation depuis une annonce":"Choisissez une conversation pour commencer \xe0 discuter"})]})})})]})})]})}):(0,y.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,y.jsx)("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-primary-600"})})}},2811:(e,t,s)=>{s.d(t,{A:()=>l});var r=s(3986),a=s(5043);const n=["title","titleId"];function i(e,t){let{title:s,titleId:i}=e,l=(0,r.A)(e,n);return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":i},l),s?a.createElement("title",{id:i},s):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125"}))}const l=a.forwardRef(i)},4538:(e,t,s)=>{s.d(t,{A:()=>l});var r=s(3986),a=s(5043);const n=["title","titleId"];function i(e,t){let{title:s,titleId:i}=e,l=(0,r.A)(e,n);return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":i},l),s?a.createElement("title",{id:i},s):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"}))}const l=a.forwardRef(i)},7438:(e,t,s)=>{s.d(t,{A:()=>l});var r=s(3986),a=s(5043);const n=["title","titleId"];function i(e,t){let{title:s,titleId:i}=e,l=(0,r.A)(e,n);return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":i},l),s?a.createElement("title",{id:i},s):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"}))}const l=a.forwardRef(i)},9422:(e,t,s)=>{s.d(t,{A:()=>l});var r=s(3986),a=s(5043);const n=["title","titleId"];function i(e,t){let{title:s,titleId:i}=e,l=(0,r.A)(e,n);return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":i},l),s?a.createElement("title",{id:i},s):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m4.5 12.75 6 6 9-13.5"}))}const l=a.forwardRef(i)}}]);
//# sourceMappingURL=411.17f6d7ac.chunk.js.map