"use strict";(self.webpackChunkcolocation_antananarivo=self.webpackChunkcolocation_antananarivo||[]).push([[411],{1792:(e,t,s)=>{s.r(t),s.d(t,{default:()=>k});var r=s(5043),n=s(3216),a=s(8927),i=s(9741),l=s(3063),c=s(3986);const o=["title","titleId"];function d(e,t){let{title:s,titleId:n}=e,a=(0,c.A)(e,o);return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":n},a),s?r.createElement("title",{id:n},s):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"}))}const m=r.forwardRef(d);var u=s(5442),x=s(7591),h=s(4538),f=s(9422),v=s(2811);const g=["title","titleId"];function p(e,t){let{title:s,titleId:n}=e,a=(0,c.A)(e,g);return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":n},a),s?r.createElement("title",{id:n},s):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"}))}const w=r.forwardRef(p);var j=s(7438),b=s(8378),y=s(2227),N=s(579);const k=()=>{var e,t;const{conversations:s,sendMessage:c,markAsRead:o,getConversationMessages:d,loading:g,editMessage:p,deleteMessage:k,deleteConversation:E}=(0,a.J)(),{user:S}=(0,i.A)(),A=(0,n.zy)(),[C,L]=(0,r.useState)(null),[I,M]=(0,r.useState)(""),[R,z]=(0,r.useState)([]),[O,W]=(0,r.useState)(!1),[B,Z]=(0,r.useState)(new Set),[_,P]=(0,r.useState)(!1),D=(0,r.useRef)(null),[F,J]=(0,r.useState)(null),[q,K]=(0,r.useState)(new Set),[T,H]=(0,r.useState)(!1),U=s.find(e=>e.id===C),V=(0,r.useCallback)(async e=>{if(!d)return;const t=await d(e);z(t)},[d]);(0,r.useEffect)(()=>{C&&V(C)},[C,V]),(0,r.useEffect)(()=>{var e;null===(e=D.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[R]),(0,r.useEffect)(()=>{if(C&&S&&o){const e=R.filter(e=>e.receiverId===S.id&&!e.isRead);e.length>0&&Z(e=>new Set([...e,C])),e.forEach(async e=>{try{await o(e.id)}catch(t){console.error("Erreur marquage comme lu:",t)}})}},[C,R,S,o]);const G=async()=>{if(!I.trim()||!U||!S||O)return;const e=U.participants.find(e=>e.id!==S.id);if(e){W(!0);try{await c(e.id,I),M(""),C&&await V(C)}catch(t){console.error("Erreur lors de l'envoi du message:",t)}finally{W(!1)}}};(0,r.useEffect)(()=>{!(s.length>0)||C||g||_||T||L(s[0].id)},[s,C,g,_,T]),(0,r.useEffect)(()=>{const e=new URLSearchParams(A.search),t=e.get("to"),r=e.get("prefill");if(!t||0===s.length)return;const n=s.find(e=>e.participants.some(e=>String(e.id)===String(t)));n&&(L(n.id),r&&M(r))},[A.search,s]),(0,r.useEffect)(()=>{C&&P(!1)},[C]),(0,r.useEffect)(()=>{if(!S)return;const e="hidden_conversations_".concat(S.id);try{const t=localStorage.getItem(e);t&&K(new Set(JSON.parse(t)))}catch(t){}},[S]),(0,r.useEffect)(()=>{const e=()=>{H(window.innerWidth<1024)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Q=e=>{K(t=>{const s=new Set(t);return s.add(e),(e=>{if(!S)return;const t="hidden_conversations_".concat(S.id);try{localStorage.setItem(t,JSON.stringify(Array.from(e)))}catch(s){}})(s),s}),C===e&&L(null),J(null)};(0,r.useEffect)(()=>{const e=()=>J(null);return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[]);const X=!T||!C,Y=!T||!!C,$=null===U||void 0===U?void 0:U.participants.find(e=>e.id!==(null===S||void 0===S?void 0:S.id));return S?(0,N.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,N.jsxs)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[(0,N.jsxs)("div",{className:"mb-8",children:[(0,N.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"Messages"}),(0,N.jsx)("p",{className:"text-gray-600",children:"Communiquez avec les propri\xe9taires et les \xe9tudiants"})]}),(0,N.jsx)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:(0,N.jsxs)("div",{className:"flex flex-col lg:flex-row h-[calc(100vh-220px)] min-h-[520px]",children:[(0,N.jsxs)("div",{className:"".concat(X?"flex":"hidden"," lg:flex lg:w-1/3 border-r border-gray-200 flex-col bg-white"),children:[(0,N.jsx)("div",{className:"p-4 border-b border-gray-200",children:(0,N.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"Conversations"})}),(0,N.jsx)("div",{className:"flex-1 overflow-y-auto",children:g?(0,N.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,N.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"})}):0===s.filter(e=>!q.has(e.id)).length?(0,N.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[(0,N.jsx)(l.A,{className:"w-12 h-12 mb-4"}),(0,N.jsx)("p",{className:"text-center",children:"Aucune conversation"}),(0,N.jsx)("p",{className:"text-sm text-center mt-2",children:"Commencez une nouvelle conversation depuis une annonce"})]}):(0,N.jsx)("div",{className:"space-y-1",children:s.filter(e=>!q.has(e.id)).map(e=>{const t=e.participants.find(e=>e.id!==S.id);if(!t)return null;const s=(e=>{if(C===e.id)return 0;if(B.has(e.id))return 0;const t=e.lastMessage;if(!t)return 0;const s=String(t.senderId)!==String(null===S||void 0===S?void 0:S.id),r=!t.isRead;return s&&r?1:0})(e);return(0,N.jsx)("button",{onClick:()=>{L(e.id),J(null),P(!1)},className:"w-full p-4 text-left hover:bg-gray-50 transition-colors ".concat(C===e.id?"bg-primary-50 border-r-2 border-primary-500":""),children:(0,N.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,N.jsx)("div",{className:"w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center",children:(0,N.jsxs)("span",{className:"text-primary-600 font-medium text-sm",children:[t.firstName[0],t.lastName[0]]})}),(0,N.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,N.jsxs)("div",{className:"flex items-center justify-between",children:[(0,N.jsxs)("h3",{className:"text-sm font-medium text-gray-900 truncate",children:[t.firstName," ",t.lastName]}),(0,N.jsxs)("div",{className:"flex items-center space-x-2",onClick:e=>e.stopPropagation(),children:[s>0&&(0,N.jsx)("span",{className:"bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:s}),(0,N.jsxs)("div",{className:"relative",children:[(0,N.jsx)("button",{className:"p-1 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-100",title:"Options",onClick:t=>{t.stopPropagation(),J(t=>t===e.id?null:e.id)},children:(0,N.jsx)(m,{className:"w-5 h-5"})}),F===e.id&&(0,N.jsx)("div",{className:"absolute right-0 mt-1 bg-white border border-gray-200 rounded shadow z-10",children:(0,N.jsx)("button",{className:"block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100",onClick:()=>Q(e.id),children:"Supprimer pour moi"})})]})]})]}),e.lastMessage&&(0,N.jsx)("p",{className:"text-sm truncate ".concat(s>0?"text-gray-900 font-medium":"text-gray-500"),children:e.lastMessage.content}),(0,N.jsx)("p",{className:"text-xs text-gray-400",children:e.lastMessage&&(0,b.m)(new Date(e.lastMessage.createdAt),{addSuffix:!0,locale:y.fr})})]})]})},e.id)})})})]}),(0,N.jsx)("div",{className:"".concat(Y?"flex":"hidden"," flex-1 flex-col bg-gray-50"),children:U?(0,N.jsxs)(N.Fragment,{children:[(0,N.jsxs)("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between bg-white",children:[(0,N.jsxs)("div",{className:"flex items-center space-x-3",children:[T&&(0,N.jsx)("button",{onClick:()=>{L(null),P(!0)},className:"mr-2 rounded-full p-2 text-gray-500 hover:text-gray-800 hover:bg-gray-100",title:"Retour aux conversations",children:(0,N.jsx)(u.A,{className:"w-5 h-5"})}),(0,N.jsx)("div",{className:"w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center",children:(0,N.jsxs)("span",{className:"text-primary-600 font-medium text-sm",children:[null===$||void 0===$||null===(e=$.firstName)||void 0===e?void 0:e[0],null===$||void 0===$||null===(t=$.lastName)||void 0===t?void 0:t[0]]})}),(0,N.jsxs)("div",{children:[(0,N.jsxs)("h3",{className:"text-lg font-semibold text-gray-900",children:[null===$||void 0===$?void 0:$.firstName," ",null===$||void 0===$?void 0:$.lastName]}),(0,N.jsx)("p",{className:"text-sm text-gray-500",children:"student"===(null===$||void 0===$?void 0:$.userType)?"\xc9tudiant":"Propri\xe9taire"})]})]}),(0,N.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,N.jsx)("button",{onClick:()=>{L(null),M(""),P(!0)},className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors",title:"Fermer la conversation",children:(0,N.jsx)(x.A,{className:"w-5 h-5"})}),(0,N.jsx)("button",{onClick:async()=>{if(C&&window.confirm("Supprimer cette conversation ? Cette action est irr\xe9versible."))try{await E(C),L(null)}catch(e){}},className:"text-sm text-red-600 hover:text-red-700",title:"Supprimer la conversation",children:"Supprimer"})]})]}),(0,N.jsx)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:0===R.length?(0,N.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[(0,N.jsx)(l.A,{className:"w-12 h-12 mb-4"}),(0,N.jsx)("p",{children:"Aucun message dans cette conversation"}),(0,N.jsx)("p",{className:"text-sm",children:"Envoyez le premier message !"})]}):(0,N.jsx)(N.Fragment,{children:R.map(e=>{const t=String(e.senderId)===String(S.id);return(0,N.jsx)("div",{className:"flex ".concat(t?"justify-end":"justify-start"," mb-2"),children:(0,N.jsxs)("div",{className:"max-w-[75%] px-4 py-2 rounded-2xl shadow-sm ".concat(t?"bg-primary-600 text-white rounded-br-none":"bg-gray-100 text-gray-900 rounded-bl-none border border-gray-200"),children:[(0,N.jsx)("p",{className:"text-sm break-words",children:e.content}),(0,N.jsxs)("div",{className:"flex items-center justify-end mt-1 space-x-1 text-xs ".concat(t?"text-primary-100":"text-gray-500"),children:[(0,N.jsx)("span",{children:(0,b.m)(new Date(e.createdAt),{addSuffix:!0,locale:y.fr})}),t&&(0,N.jsx)("div",{className:"flex items-center",children:e.isRead?(0,N.jsx)(h.A,{className:"w-3 h-3"}):(0,N.jsx)(f.A,{className:"w-3 h-3"})})]}),t&&(0,N.jsxs)("div",{className:"mt-1 flex justify-end space-x-1 text-xs",children:[(0,N.jsx)("button",{className:"p-1 rounded-full text-blue-600 hover:text-blue-700 hover:bg-blue-50",title:"Modifier le message",onClick:async()=>{const t=prompt("Modifier le message:",e.content);if(null!==t&&t.trim()&&t!==e.content)try{await p(e.id,t)}catch(s){}},children:(0,N.jsx)(v.A,{className:"w-4 h-4"})}),(0,N.jsx)("button",{className:"p-1 rounded-full text-red-600 hover:text-red-700 hover:bg-red-50",title:"Supprimer le message",onClick:async()=>{if(window.confirm("Supprimer ce message ?"))try{await k(e.id)}catch(t){}},children:(0,N.jsx)(w,{className:"w-4 h-4"})})]})]})},e.id)})})}),(0,N.jsx)("div",{className:"p-4 border-t border-gray-200 bg-white",children:(0,N.jsxs)("div",{className:"flex space-x-2",children:[(0,N.jsx)("textarea",{value:I,onChange:e=>M(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),G())},placeholder:"Tapez votre message...",rows:2,className:"flex-1 input-field resize-none",disabled:O}),(0,N.jsx)("button",{onClick:G,disabled:!I.trim()||O,className:"btn-primary flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed",children:O?(0,N.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):(0,N.jsx)(j.A,{className:"w-4 h-4"})})]})})]}):(0,N.jsx)("div",{className:"flex-1 flex items-center justify-center text-gray-500 bg-white",children:(0,N.jsxs)("div",{className:"text-center px-6",children:[(0,N.jsx)(l.A,{className:"w-16 h-16 mx-auto mb-4 text-primary-400"}),(0,N.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:0===s.length?"Aucune conversation":"S\xe9lectionnez une conversation"}),(0,N.jsx)("p",{className:"text-sm text-gray-500",children:0===s.length?"Commencez une nouvelle conversation depuis une annonce.":"Choisissez une conversation pour commencer \xe0 discuter."})]})})})]})})]})}):(0,N.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,N.jsx)("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-primary-600"})})}},2811:(e,t,s)=>{s.d(t,{A:()=>l});var r=s(3986),n=s(5043);const a=["title","titleId"];function i(e,t){let{title:s,titleId:i}=e,l=(0,r.A)(e,a);return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":i},l),s?n.createElement("title",{id:i},s):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125"}))}const l=n.forwardRef(i)},4538:(e,t,s)=>{s.d(t,{A:()=>l});var r=s(3986),n=s(5043);const a=["title","titleId"];function i(e,t){let{title:s,titleId:i}=e,l=(0,r.A)(e,a);return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":i},l),s?n.createElement("title",{id:i},s):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"}))}const l=n.forwardRef(i)},5442:(e,t,s)=>{s.d(t,{A:()=>l});var r=s(3986),n=s(5043);const a=["title","titleId"];function i(e,t){let{title:s,titleId:i}=e,l=(0,r.A)(e,a);return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":i},l),s?n.createElement("title",{id:i},s):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"}))}const l=n.forwardRef(i)},7438:(e,t,s)=>{s.d(t,{A:()=>l});var r=s(3986),n=s(5043);const a=["title","titleId"];function i(e,t){let{title:s,titleId:i}=e,l=(0,r.A)(e,a);return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":i},l),s?n.createElement("title",{id:i},s):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"}))}const l=n.forwardRef(i)},9422:(e,t,s)=>{s.d(t,{A:()=>l});var r=s(3986),n=s(5043);const a=["title","titleId"];function i(e,t){let{title:s,titleId:i}=e,l=(0,r.A)(e,a);return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":i},l),s?n.createElement("title",{id:i},s):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m4.5 12.75 6 6 9-13.5"}))}const l=n.forwardRef(i)}}]);
//# sourceMappingURL=411.55c5aac8.chunk.js.map